<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FRUTEXSA - CONTADOR Máquina</title>

<style>
body {
    font-family: Arial;
    background-color: #111;
    color: #fff;
    text-align: center;
}
button {
    padding: 10px 20px;
    margin: 10px;
    font-size: 18px;
}
#contador {
    font-size: 70px;
    margin-top: 20px;
}
#estado {
    margin-top: 10px;
    font-weight: bold;
}
input {
    padding: 10px;
    font-size: 16px;
}
</style>
</head>

<body>

<h2>CONTADOR - FRUTEXSA</h2>
<h3 id="machine"></h3>

<input type="password" id="password" placeholder="Ingrese contraseña">
<br>
<button onclick="login()">Ingresar</button>

<div id="panel" style="display:none;">
    <button onclick="connect()">Conectar</button>
    <div id="estado">Desconectado</div>
    <div id="contador">0</div>
    <button id="resetBtn" style="display:none;">RESET</button>
</div>

<script>

const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_COUNTER_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_AUTH_UUID = "3c9a3f00-8ed3-4b6f-9a6f-5c2e9b7a1234";

let characteristicCounter;
let characteristicAuth;
let nivel = "";

let machineID = new URLSearchParams(window.location.search).get("id");

if(machineID){
    document.getElementById("machine").innerText = "Máquina: " + machineID;
} else {
    alert("No se especificó ID de máquina en la URL");
}

function login(){
    nivel = document.getElementById("password").value;
    if(nivel.length === 0){
        alert("Ingrese contraseña");
        return;
    }
    document.getElementById("panel").style.display = "block";
}

async function connect(){

    try {

        const device = await navigator.bluetooth.requestDevice({
  acceptAllDevices: true,
  optionalServices: [SERVICE_UUID]
});

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);

        characteristicCounter = await service.getCharacteristic(CHAR_COUNTER_UUID);
        characteristicAuth = await service.getCharacteristic(CHAR_AUTH_UUID);

        // ---- CONTADOR ----
        await characteristicCounter.startNotifications();
        characteristicCounter.addEventListener(
            'characteristicvaluechanged',
            event => {
                const value = new TextDecoder().decode(event.target.value);
                document.getElementById("contador").innerText = value;
            }
        );

        // ---- AUTH ----
        await characteristicAuth.startNotifications();

        characteristicAuth.addEventListener(
            'characteristicvaluechanged',
            event => {
                const response = new TextDecoder().decode(event.target.value);

                if(response === "SUPERVISOR_OK"){
                    document.getElementById("resetBtn").style.display = "inline-block";
                    alert("Acceso Supervisor");
                }
                else if(response === "OPERADOR_OK"){
                    alert("Acceso Operador");
                }
                else{
                    alert("Acceso Denegado");
                }
            }
        );

        // Enviar contraseña después de activar notificaciones
        await characteristicAuth.writeValue(
            new TextEncoder().encode(nivel)
        );

        document.getElementById("estado").innerText = "Conectado";

    } catch(error) {
        alert("Error: " + error);
    }
}

</script>

</body>
</html>
