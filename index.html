<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FRUTEXSA - CONTADOR Máquina</title>

<style>
body {
    font-family: Arial;
    background-color: #111;
    color: #fff;
    text-align: center;
}
button {
    padding: 10px 20px;
    margin: 10px;
    font-size: 18px;
}
#contador {
    font-size: 70px;
    margin-top: 20px;
}
#contadorTotal {
    font-size: 30px;
    margin-top: 10px;
    color: #00ff88;
}
#estado {
    margin-top: 10px;
    font-weight: bold;
}
input {
    padding: 10px;
    font-size: 16px;
}
</style>
</head>

<body>

<h2>CONTADOR - FRUTEXSA</h2>

<input type="password" id="password" placeholder="Ingrese contraseña">
<br>
<button onclick="login()">Ingresar</button>

<div id="panel" style="display:none;">
    <button onclick="connect()">Conectar</button>
    <div id="estado">Desconectado</div>

    <div id="contador">0</div>
    <div>Total Histórico: <span id="contadorTotal">0</span></div>

    <button id="resetBtn" style="display:none;" onclick="resetContador()">RESET</button>
    <button id="resetTotalBtn" style="display:none;" onclick="resetHistorico()">RESET HISTORICO</button>

</div>

<script>

const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_COUNTER_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_AUTH_UUID = "3c9a3f00-8ed3-4b6f-9a6f-5c2e9b7a1234";

let characteristicCounter;
let characteristicAuth;
let nivel = "";

// -------- LOGIN --------
function login(){
    nivel = document.getElementById("password").value;
    if(nivel.length === 0){
        alert("Ingrese contraseña");
        return;
    }
    document.getElementById("panel").style.display = "block";
}

// -------- CONECTAR --------
async function connect(){

    try {

        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SERVICE_UUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);

        characteristicCounter = await service.getCharacteristic(CHAR_COUNTER_UUID);
        characteristicAuth = await service.getCharacteristic(CHAR_AUTH_UUID);

        // ---- CONTADOR ----
        await characteristicCounter.startNotifications();
        characteristicCounter.addEventListener(
            'characteristicvaluechanged',
            event => {

                const value = new TextDecoder().decode(event.target.value);
                const partes = value.split(",");

                document.getElementById("contador").innerText = partes[0];

                if(partes.length > 1){
                    document.getElementById("contadorTotal").innerText = partes[1];
                }
            }
        );

        // ---- AUTH ----
        await characteristicAuth.startNotifications();

        characteristicAuth.addEventListener(
            'characteristicvaluechanged',
            event => {

                const response = new TextDecoder().decode(event.target.value);

                if(response === "SUPERVISOR_OK"){
                    document.getElementById("resetBtn").style.display = "inline-block";
                    alert("Acceso Supervisor");
                }
                else if(response === "OPERADOR_OK"){
                    alert("Acceso Operador");
                }
                else if(response === "DISTRIBUIDOR_OK"){
    document.getElementById("resetBtn").style.display = "inline-block";
    document.getElementById("resetTotalBtn").style.display = "inline-block";
    alert("Acceso Distribuidor");
}

                else if(response === "BLOQUEADO"){
                    alert("Sistema bloqueado 30 segundos");
                }
                else{
                    alert("Acceso Denegado");
                }
            }
        );

        await characteristicAuth.writeValue(
            new TextEncoder().encode(nivel)
        );

        document.getElementById("estado").innerText = "Conectado";

    } catch(error) {
        alert("Error: " + error);
    }
}

// -------- RESET --------
async function resetContador() {

    if(!characteristicAuth){
        alert("No conectado");
        return;
    }

    try {
        await characteristicAuth.writeValue(
            new TextEncoder().encode("RESET")
        );
    } catch(error) {
        alert("Error enviando reset: " + error);
    }
}
    async function resetHistorico() {

    if(!confirm("Confirma borrar contador histórico?")){
        return;
    }

    await characteristicAuth.writeValue(
        new TextEncoder().encode("RESET_TOTAL")
    );
}


</script>

</body>
</html>
